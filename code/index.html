<!DOCTYPE html>
<html>
  <head>
    <title>Learning experiment</title>
    <script src="functions.js"></script>
    <script src="trials.js"></script>
    <script src="https://unpkg.com/jspsych@7.3.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-image-keyboard-response@1.1.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-preload@1.1.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.3"></script> 
    <script src="https://unpkg.com/@jspsych/plugin-image-button-response@1.1.2"></script>
    <link href="https://unpkg.com/jspsych@7.3.3/css/jspsych.css" rel="stylesheet" type="text/css" />
  </head>
  <body></body>
  <script>


  var jsPsych = initJsPsych({
    default_ITI: 250, 
    on_finish: function() {


        // Save the total duration of the experiment in seconds
        const totalDuration = jsPsych.getTotalTime() / 1000; // Convert to seconds
        jsPsych.data.addProperties({ totalDuration: totalDuration });

        // Convert the data to CSV format
        const csvData = jsPsych.data.get().csv();

        // Create a Blob object containing the CSV data
        const blob = new Blob([csvData], { type: 'text/csv;charset=utf-8' });

        // Create a download link
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = subject_id+'.csv';

        // Trigger a click event to start the download
        link.click();
      }
    });

  //creates a random id for subjects
  var subject_id = jsPsych.randomization.randomID(15);

  //filtering by phase
  var training_trials = trials.filter(item => item.phase === 'training');
  var testing_trials =  trials.filter(item => item.phase === 'testing');

  // selects words
  var words = ['sluck', 'zeck', 'teeb', 'stig', 'narp']

  //shuffle the array of words
  shuffle(words)
    
    // map the first word in the array to the meaning ALL, the second one to the meaning NONE 
    var word_ALL = words[0]
    var word_NONE = words[1]

    //replace all the instances of 'ALL' per the word you choose for word_ALL
    replaceValuesForKeys(testing_trials, ['expected_answer'], 'ALL', word_ALL);
    replaceValuesForKeys(training_trials, ['expected_answer'], 'ALL', word_ALL);

    //replace all the instances of 'NONE' per the word you choose for word_NONE
    replaceValuesForKeys(testing_trials, ['expected_answer'], 'NONE', word_NONE);
    replaceValuesForKeys(training_trials, ['expected_answer'], 'NONE', word_NONE);

    // capture info from Prolific
    var prolific_id = jsPsych.data.getURLVariable('PROLIFIC_PID');
    var study_id = jsPsych.data.getURLVariable('STUDY_ID');
    var session_id = jsPsych.data.getURLVariable('SESSION_ID');

    jsPsych.data.addProperties({
      subject: subject_id,
      prolific_id: prolific_id,
      word_ALL: word_ALL, 
      word_NONE: word_NONE
    });


    /* create timeline */
    var timeline = [];

    /* preload images */
    var preload = {
      type: jsPsychPreload,
      images: ['img/bluehouse.png', 'img/redcar.png']
    };
    timeline.push(preload);


    /* define welcome message trial */
    var welcome = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: function(){
        var html = `Now fill in the following sentences with <i>${word_ALL}</i> or <i>${word_NONE}</i>. Press any key to begin.
        `;
        return html;
      },
    };
    timeline.push(welcome);

var train_phase = {
      timeline:[
      {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: '<div style="font-size:60px;">+</div>',
      choices: "NO_KEYS",
      trial_duration: 250
      },
      {
        type: jsPsychHtmlButtonResponse,
        stimulus: function(){
            var html = `<p>The ${jsPsych.timelineVariable('sentence')} is <b>${jsPsych.timelineVariable('expected_answer')}</b></p>`;
            return html},
        choices: function() {return jsPsych.randomization.shuffle(['img/'+jsPsych.timelineVariable('target_picture')+'.png', 'img/'+jsPsych.timelineVariable('foil_picture')+'.png']);},
        button_html: '<button class="jspsych-btn"><img src="%choice%" style="width:200px; height:150px"/></button>',
        post_trial_grap: 300, 
        save_trial_parameters: {
            // save the randomly-selected button order 
            choices: true,
            // don't save the stimulus
            stimulus: false
          },
          data:{
            phase: jsPsych.timelineVariable("phase"),
            sentence: jsPsych.timelineVariable("sentence"),
            target_picture: jsPsych.timelineVariable("target_picture"),
            foil_picture: jsPsych.timelineVariable("foil_picture"),
            type: jsPsych.timelineVariable("trial_type"),          
            meaning: jsPsych.timelineVariable("meaning"),
            expected_answer: jsPsych.timelineVariable("expected_answer")
          },
         on_finish: function(data){
            data.img_response = data.choices[data.response]
            // Score the keyboard response as correct or incorrect.
             if(data.img_response == jsPsych.timelineVariable('target_picture')){
                data.correct = true;
            } else {
                data.correct = false; 
            }
            console.log(data.correct)
  }
    }],  
      timeline_variables:training_trials,
      randomize_order: true} ;
    //timeline.push(train_phase);


    var test_phase = {
      timeline:[
      {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: '<div style="font-size:60px;">+</div>',
      choices: "NO_KEYS",
      trial_duration: 250
      },

      {
      type: jsPsychHtmlButtonResponse,
      stimulus: function(){
        var html = `
            <img style="width:350px; height:150px; border:1px solid black; border-radius: 15px;" src="img/${jsPsych.timelineVariable('target_picture')}.png">
            <p>The ${jsPsych.timelineVariable('sentence')} is _______ </p>`;
        return html;
      },
      prompt : '',
      choices: [word_NONE, word_ALL], 
      save_trial_parameters: {
            // don't save the stimulus
            stimulus: false
          },

      //here we save informtion about the trial
      data:{
            phase: jsPsych.timelineVariable("phase"),
            sentence: jsPsych.timelineVariable("sentence"),
            picture: jsPsych.timelineVariable("target_picture"),
            type: jsPsych.timelineVariable("trial_type"),          
            meaning: jsPsych.timelineVariable("meaning"),
            expected_answer: jsPsych.timelineVariable("expected_answer")
          },
      
      //here we save the informaiton about the responses
      on_finish(data){
      var response = data.response; //this is a 0 or a 1
      var actual_response = (response==0) ? word_NONE : word_ALL; //this is the actual, artificial word
      var coded_response = (response==0) ? 'NONE' : 'ALL'; //this is whether the word is coded as NONE or ALL 

      data.actual_response = actual_response;
      data.coded_response = coded_response;

      //non_extrapolation
      if(jsPsych.timelineVariable('trial_type') =='not_extrapolation') {
        data.correct = (actual_response==jsPsych.timelineVariable('expected_answer')) ? true : false
        data.meaning_chosen = (coded_response=='ALL') ? 'all' : 'none'
      }
      //extrapolation
      else if(jsPsych.timelineVariable('trial_type') =='extrapolation'){
        data.correct = 'NA',
        data.meaning_chosen = (coded_response=='ALL') ? 'some' : 'nall'
      }
      }
      }],
      timeline_variables:testing_trials,
      randomize_order: true} ;
    timeline.push(test_phase);




    /* start the experiment */
    jsPsych.run(timeline);

  </script>
</html>
